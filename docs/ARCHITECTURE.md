# システムアーキテクチャ

グリーンNH₃レジストリシステムの技術アーキテクチャドキュメント

## システム概要

本システムは、グリーンアンモニア証書の発行・取引・管理を行うデモプラットフォームです。NFT技術とブロックチェーンを活用し、改ざん防止と透明性を確保します。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                     フロントエンド層                          │
│                   (HTML5 / CSS3 / JS)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ダッシュ  │  │ 証書管理 │  │ 取引履歴 │  │レポート  │   │
│  │ボード   │  │         │  │         │  │生成     │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                    REST API層 (Express.js)                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │統計API   │  │証書API   │  │取引API   │  │BC API    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                    ビジネスロジック層                         │
│  ┌────────────────────┐  ┌────────────────────┐            │
│  │ 証書管理サービス    │  │ ブロックチェーン    │            │
│  │ - 発行            │  │ サービス           │            │
│  │ - 検証            │  │ - マイニング       │            │
│  │ - 取引            │  │ - 検証            │            │
│  └────────────────────┘  │ - NFT発行         │            │
│                         └────────────────────┘            │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                      データ層                                 │
│  ┌────────────────────┐  ┌────────────────────┐            │
│  │ In-Memory Store    │  │ ブロックチェーン    │            │
│  │ - 証書データ       │  │ - ブロック         │            │
│  │ - 取引データ       │  │ - トランザクション │            │
│  │ - センサーデータ   │  │ - NFTメタデータ    │            │
│  └────────────────────┘  └────────────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. フロントエンド層

**技術スタック**
- HTML5: セマンティックマークアップ
- CSS3: モダンなUIデザイン、アニメーション
- Vanilla JavaScript: DOM操作、API通信

**主要機能**
- リアルタイムダッシュボード表示
- センサーデータの可視化
- 証書管理UI
- 取引履歴表示
- レポート生成インターフェース

### 2. REST API層

**技術スタック**
- Node.js: ランタイム環境
- Express.js: Webフレームワーク
- CORS: クロスオリジンリクエスト対応

**エンドポイント設計**
- `/api/stats` - 統計情報
- `/api/sensors` - センサーデータ
- `/api/certificates` - 証書管理
- `/api/transactions` - 取引管理
- `/api/blockchain/*` - ブロックチェーン操作
- `/api/reports` - レポート生成

### 3. ビジネスロジック層

#### 証書管理サービス
- 証書の発行
- 証書の検証
- 取引の作成・更新
- レポート生成

#### ブロックチェーンサービス
- ブロックのマイニング（Proof of Work）
- チェーンの検証
- NFTの発行
- トランザクションの記録

**アルゴリズム**
- ハッシュ関数: SHA-256
- 難易度: 可変（現在: 2）
- コンセンサス: Proof of Work

### 4. データ層

**データモデル**

#### Certificate（証書）
```javascript
{
  id: String,              // 証書ID
  nftId: String,           // NFT ID
  amount: Number,          // 数量（トン）
  issuer: String,          // 発行者
  type: String,            // タイプ
  issueDate: String,       // 発行日
  status: String,          // ステータス
  blockchainHash: String,  // BCハッシュ
  createdAt: String,       // 作成日時
  updatedAt: String        // 更新日時
}
```

#### Transaction（取引）
```javascript
{
  id: String,              // 取引ID
  certificateId: String,   // 証書ID
  nftId: String,           // NFT ID
  sender: String,          // 送信者
  receiver: String,        // 受信者
  amount: Number,          // 数量
  value: Number,           // 取引額
  status: String,          // ステータス
  blockchainHash: String,  // BCハッシュ
  timestamp: String        // タイムスタンプ
}
```

#### Block（ブロック）
```javascript
{
  index: Number,           // ブロック番号
  timestamp: String,       // タイムスタンプ
  transactions: Array,     // トランザクション
  nonce: Number,           // ナンス
  hash: String,            // ブロックハッシュ
  previousHash: String     // 前のブロックハッシュ
}
```

## データフロー

### 証書発行フロー

```
1. ユーザーが証書発行リクエスト
   ↓
2. API層で入力バリデーション
   ↓
3. Certificate モデル作成
   ↓
4. ブロックチェーンサービスでNFT発行
   ↓
5. ブロックにトランザクション追加
   ↓
6. Proof of Work によるマイニング
   ↓
7. ブロックチェーンに追加
   ↓
8. 証書データをストアに保存
   ↓
9. レスポンスを返却
```

### 取引作成フロー

```
1. ユーザーが取引作成リクエスト
   ↓
2. 証書の存在確認
   ↓
3. Transaction モデル作成
   ↓
4. ブロックチェーンに記録
   ↓
5. 取引データをストアに保存
   ↓
6. レスポンスを返却
```

## セキュリティ設計

### ブロックチェーンによる改ざん防止

1. **ハッシュチェーン**
   - 各ブロックが前のブロックのハッシュを含む
   - 改ざんすると以降のすべてのハッシュが変わる

2. **Proof of Work**
   - 計算量の多い問題を解く必要がある
   - 改ざんには膨大な計算コストが必要

3. **NFT発行**
   - 各証書に一意のNFT IDを付与
   - ブロックチェーン上で追跡可能

### データ検証

- チェーン全体の整合性検証
- ハッシュの再計算と比較
- 取引の署名検証（将来実装）

## スケーラビリティ

### 現在のデモの制限

- In-Memoryストレージ（再起動でデータ消失）
- 単一サーバー構成
- 同期処理

### 本番環境への拡張案

1. **データベース統合**
   - PostgreSQL: トランザクションデータ
   - MongoDB: ドキュメントデータ
   - Redis: キャッシュ層

2. **分散システム化**
   - マイクロサービスアーキテクチャ
   - メッセージキュー（RabbitMQ, Kafka）
   - ロードバランサー

3. **実ブロックチェーン連携**
   - Ethereum / Polygon
   - スマートコントラクト実装
   - Web3.js統合

4. **スケーラビリティ向上**
   - 水平スケーリング
   - CDN活用
   - 非同期処理

## パフォーマンス最適化

### フロントエンド
- 遅延読み込み
- 仮想スクロール
- キャッシング

### バックエンド
- データベースインデックス
- クエリ最適化
- 接続プーリング

### ブロックチェーン
- 難易度調整
- バッチ処理
- オフチェーンストレージ

## モニタリング

### メトリクス
- API レスポンスタイム
- ブロックチェーンの状態
- トランザクション数
- エラー率

### ログ
- アクセスログ
- エラーログ
- トランザクションログ
- ブロックチェーンログ

## デプロイメント

### 開発環境
```bash
npm run dev
```

### 本番環境
```bash
npm start
```

### Docker化（将来）
```dockerfile
FROM node:14
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

## 技術的負債と改善点

### 短期的改善
- [ ] ユニットテスト追加
- [ ] エラーハンドリング強化
- [ ] ログ機能追加
- [ ] 環境変数管理

### 中期的改善
- [ ] データベース統合
- [ ] 認証・認可システム
- [ ] WebSocket対応
- [ ] TypeScript移行

### 長期的改善
- [ ] 実ブロックチェーン連携
- [ ] マイクロサービス化
- [ ] Kubernetes対応
- [ ] AI/ML統合

## 参考資料

- [Node.js公式ドキュメント](https://nodejs.org/)
- [Express.js公式ドキュメント](https://expressjs.com/)
- [環境省MRVガイドライン](https://www.env.go.jp/)
- [IMO排出削減戦略](https://www.imo.org/)
